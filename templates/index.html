<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Academic Study Planner (SASP)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --accent-blue: #3498db;
            --accent-green: #27ae60;
            --accent-red: #e74c3c;
            --accent-purple: #9b59b6;
            --border-color: #e9ecef;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        [data-theme="dark"] {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --text-primary: #eee;
            --text-secondary: #aaa;
            --border-color: #2a2a4a;
            --shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg-primary); padding: 20px; color: var(--text-primary); transition: all 0.3s; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        header { background: linear-gradient(135deg, #2c3e50, #4a6491); color: white; padding: 25px; border-radius: 10px; text-align: center; margin-bottom: 20px; position: relative; }
        header h1 { font-size: 2rem; margin-bottom: 10px; }
        
        .header-actions { position: absolute; top: 15px; right: 15px; display: flex; gap: 10px; }
        .icon-btn { background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.1rem; transition: all 0.3s; }
        .icon-btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.1); }
        
        .section { background: var(--bg-secondary); padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: var(--shadow); }
        .section h2 { color: var(--text-primary); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .step-num { background: var(--accent-blue); color: white; width: 30px; height: 30px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; }
        
        .program-btns { display: flex; gap: 10px; flex-wrap: wrap; }
        .program-btn { padding: 15px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: all 0.3s; }
        .program-btn.bscs { background: #3498db; color: white; }
        .program-btn.bsis { background: #2ecc71; color: white; }
        .program-btn.bsit { background: #e74c3c; color: white; }
        .program-btn.active { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .program-btn:hover { opacity: 0.9; }
        
        textarea { width: 100%; min-height: 150px; padding: 15px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem; margin-bottom: 10px; background: var(--bg-secondary); color: var(--text-primary); }
        textarea:focus { outline: none; border-color: var(--accent-blue); }
        
        .help-text { background: #e3f2fd; padding: 10px 15px; border-radius: 6px; color: #1976d2; font-size: 0.9rem; }
        [data-theme="dark"] .help-text { background: #1e3a5f; color: #64b5f6; }
        
        .generate-btn { background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; border: none; padding: 15px 30px; font-size: 1.1rem; font-weight: 600; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 15px; }
        .generate-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(46,204,113,0.4); }
        .generate-btn:disabled { background: #95a5a6; cursor: not-allowed; transform: none; box-shadow: none; }
        
        #results { display: none; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--bg-primary); padding: 20px; border-radius: 8px; text-align: center; border-left: 4px solid var(--accent-blue); }
        .stat-card.passed { border-left-color: var(--accent-green); }
        .stat-card.available { border-left-color: var(--accent-blue); }
        .stat-card.locked { border-left-color: var(--accent-red); }
        .stat-card.units { border-left-color: var(--accent-purple); }
        .stat-card h3 { color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 5px; }
        .stat-card .value { font-size: 2rem; font-weight: 700; color: var(--text-primary); }
        .stat-card .sub-value { font-size: 0.8rem; color: var(--text-secondary); }
        
        .progress-bar { background: var(--border-color); border-radius: 20px; height: 30px; overflow: hidden; margin-bottom: 20px; }
        .progress-fill { height: 100%; background: linear-gradient(135deg, #27ae60, #2ecc71); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; transition: width 0.5s; min-width: 50px; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .tab-btn { padding: 10px 20px; border: none; background: var(--border-color); border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--text-primary); }
        .tab-btn.active { background: #2c3e50; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #2c3e50; color: white; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid var(--border-color); color: var(--text-primary); }
        tr:hover { background: var(--bg-primary); cursor: pointer; }
        .available-row { background: rgba(39, 174, 96, 0.1); }
        .passed-row { background: rgba(52, 152, 219, 0.1); }
        .locked-row { background: rgba(231, 76, 60, 0.1); }
        .missing { color: var(--accent-red); font-weight: 500; }
        
        .loading { text-align: center; padding: 40px; display: none; }
        .loading i { font-size: 2rem; color: var(--accent-blue); animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        footer { text-align: center; color: var(--text-secondary); margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color); }
        .error { background: #ffebee; color: #c62828; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: none; }
        
        .recommendation-box { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 25px; margin-bottom: 25px; color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
        .recommendation-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .recommendation-header h3 { margin: 0; font-size: 1.4rem; display: flex; align-items: center; gap: 10px; }
        .recommendation-header h3 i { color: #ffd700; }
        .next-term-badge { background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.95rem; }
        .recommendation-subtitle { opacity: 0.9; margin-bottom: 15px; font-size: 0.95rem; }
        .recommended-stats { display: flex; gap: 25px; margin-bottom: 15px; }
        .recommended-stats span { display: flex; align-items: center; gap: 8px; font-size: 1rem; }
        .recommended-table { background: white; border-radius: 8px; overflow: hidden; }
        .recommended-table th { background: #2c3e50; color: white; padding: 12px 15px; text-align: left; }
        .recommended-table td { padding: 12px 15px; color: #2c3e50; border-bottom: 1px solid #eee; }
        .recommended-table tr:last-child td { border-bottom: none; }
        .recommended-table tr:hover { background: #f8f9fa; }
        .recommended-table .code-cell { font-weight: 700; color: #667eea; }
        
        .method-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .method-tab { padding: 12px 20px; border: none; background: var(--border-color); border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; color: var(--text-primary); }
        .method-tab:hover { background: #dee2e6; }
        .method-tab.active { background: var(--accent-blue); color: white; }
        .method-content { display: none; }
        .method-content.active { display: block; }
        
        .filter-row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-weight: 600; font-size: 0.9rem; color: var(--text-primary); }
        .filter-group select, .filter-group input { padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; min-width: 180px; background: var(--bg-secondary); color: var(--text-primary); }
        .btn-row { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .small-btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; background: var(--accent-blue); color: white; }
        .small-btn:hover { opacity: 0.9; }
        .small-btn.secondary { background: #95a5a6; }
        .small-btn.success { background: var(--accent-green); }
        .small-btn.danger { background: var(--accent-red); }
        
        .checklist { max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); }
        .checklist-header { background: #2c3e50; color: white; padding: 10px 15px; font-weight: 600; position: sticky; top: 0; z-index: 2; }
        .checklist-item { display: flex; align-items: center; padding: 10px 15px; gap: 12px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .checklist-item:hover { background: var(--bg-primary); }
        .checklist-item.checked { background: rgba(39, 174, 96, 0.1); }
        .checklist-item input { width: 18px; height: 18px; cursor: pointer; }
        .checklist-item .code { font-weight: 600; color: var(--text-primary); min-width: 80px; }
        .checklist-item .name { flex: 1; color: var(--text-secondary); }
        .checklist-item .units { font-size: 0.85rem; color: var(--text-secondary); }
        
        .selected-panel { background: var(--bg-primary); border-radius: 8px; padding: 15px; margin-top: 15px; }
        .selected-panel h4 { color: var(--text-primary); margin-bottom: 10px; }
        .selected-tags { display: flex; flex-wrap: wrap; gap: 8px; min-height: 40px; }
        .tag { display: inline-flex; align-items: center; gap: 6px; background: var(--accent-blue); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.9rem; }
        .tag button { background: none; border: none; color: white; cursor: pointer; padding: 0; font-size: 1rem; }
        .empty-msg { color: var(--text-secondary); font-style: italic; }
        
        .save-load-panel { background: var(--bg-primary); border-radius: 8px; padding: 15px; margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .save-load-panel span { color: var(--text-secondary); font-size: 0.9rem; }
        
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .chart-box { background: var(--bg-primary); padding: 20px; border-radius: 8px; }
        .chart-box h4 { color: var(--text-primary); margin-bottom: 15px; text-align: center; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--bg-secondary); border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { background: linear-gradient(135deg, #2c3e50, #4a6491); color: white; padding: 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; }
        .modal-close { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
        .modal-body { padding: 20px; }
        .modal-body .detail-row { display: flex; gap: 10px; margin-bottom: 8px; }
        .modal-body .detail-label { font-weight: 600; min-width: 120px; color: var(--text-secondary); }
        .modal-body .detail-value { color: var(--text-primary); }
        
        .gwa-section { background: var(--bg-primary); padding: 20px; border-radius: 8px; margin-top: 20px; }
        .gwa-section h4 { color: var(--text-primary); margin-bottom: 15px; }
        .grade-input-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; padding: 10px; background: var(--bg-secondary); border-radius: 6px; flex-wrap: wrap; }
        .grade-input-row .subject-name { flex: 1; font-weight: 500; color: var(--text-primary); min-width: 200px; }
        .grade-input-row .units-display { color: var(--text-secondary); font-size: 0.9rem; min-width: 60px; }
        .grade-input-row select { padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-secondary); color: var(--text-primary); }
        .gwa-result { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 8px; text-align: center; margin-top: 15px; }
        .gwa-result .gwa-value { font-size: 3rem; font-weight: 700; }
        .gwa-result .gwa-label { font-size: 1rem; opacity: 0.9; }
        
        @media (max-width: 768px) {
            body { padding: 10px; }
            header h1 { font-size: 1.5rem; }
            .header-actions { position: static; justify-content: center; margin-top: 15px; }
            .program-btns { flex-direction: column; }
            .program-btn { width: 100%; }
            .stats { grid-template-columns: repeat(2, 1fr); }
            .filter-row { flex-direction: column; }
            .filter-group select, .filter-group input { width: 100%; min-width: auto; }
            .charts-grid { grid-template-columns: 1fr; }
            .method-tabs { flex-direction: column; }
            .method-tab { width: 100%; justify-content: center; }
        }
        
        @media print {
            .header-actions, .method-tabs, .save-load-panel, .btn-row, .generate-btn, .filter-row { display: none !important; }
            body { background: white; }
            .section { box-shadow: none; border: 1px solid #ddd; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-actions">
                <button class="icon-btn" onclick="toggleTheme()" title="Toggle Dark Mode">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
                <button class="icon-btn" onclick="exportToPDF()" title="Export to PDF">
                    <i class="fas fa-file-pdf"></i>
                </button>
                <button class="icon-btn" onclick="showGWACalculator()" title="GWA Calculator">
                    <i class="fas fa-calculator"></i>
                </button>
            </div>
            <h1><i class="fas fa-graduation-cap"></i> Student Academic Study Planner</h1>
            <h3>INFORMATICS COLLEGE MANILA</h3>
        </header>

        <div class="error" id="errorMsg"></div>

        <div class="section">
            <h2><span class="step-num">1</span> Select Your Program</h2>
            <div class="program-btns">
                <button class="program-btn bscs active" onclick="selectProgram('BSCS', this)">
                    <i class="fas fa-laptop-code"></i> BSCS - Computer Science
                </button>
                <button class="program-btn bsis" onclick="selectProgram('BSIS', this)">
                    <i class="fas fa-database"></i> BSIS - Information Systems
                </button>
                <button class="program-btn bsit" onclick="selectProgram('BSIT', this)">
                    <i class="fas fa-network-wired"></i> BSIT - Information Technology
                </button>
            </div>
        </div>

        <div class="section">
            <h2><span class="step-num">2</span> Enter Subjects You've Passed</h2>
            
            <div class="save-load-panel">
                <span><i class="fas fa-save"></i> Progress:</span>
                <button class="small-btn success" onclick="saveProgress()"><i class="fas fa-save"></i> Save</button>
                <button class="small-btn" onclick="loadProgress()"><i class="fas fa-folder-open"></i> Load</button>
                <button class="small-btn danger" onclick="clearProgress()"><i class="fas fa-trash"></i> Clear</button>
                <button class="small-btn secondary" onclick="exportProgress()"><i class="fas fa-download"></i> Export</button>
                <input type="file" id="importFile" accept=".json" style="display:none" onchange="importProgress(event)">
                <button class="small-btn secondary" onclick="document.getElementById('importFile').click()"><i class="fas fa-upload"></i> Import</button>
            </div>
            
            <div class="method-tabs">
                <button class="method-tab active" onclick="switchMethod('manual')">
                    <i class="fas fa-keyboard"></i> Manual Input
                </button>
                <button class="method-tab" onclick="switchMethod('select')">
                    <i class="fas fa-list-ul"></i> Select from List
                </button>
            </div>
            
            <div id="method-manual" class="method-content active">
                <textarea id="passedInput" placeholder="Enter course codes you've passed (one per line or comma-separated)

Example:
GE111
GE112
COSC 50
DCIT 21" oninput="validateInput()"></textarea>
                <div class="help-text">
                    <i class="fas fa-info-circle"></i> Enter the course codes of subjects you have already passed to see available subjects for the next term.
                </div>
            </div>
            
            <div id="method-select" class="method-content">
                <div class="filter-row">
                    <div class="filter-group">
                        <label><i class="fas fa-calendar"></i> Year</label>
                        <select id="filter-year" onchange="filterCourses()">
                            <option value="">All Years</option>
                            <option value="First Year">1st Year</option>
                            <option value="Second Year">2nd Year</option>
                            <option value="Third Year">3rd Year</option>
                            <option value="Fourth Year">4th Year</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label><i class="fas fa-calendar-alt"></i> Term</label>
                        <select id="filter-term" onchange="filterCourses()">
                            <option value="">All Terms</option>
                            <option value="FIRST TRIMESTER">1st Term</option>
                            <option value="SECOND TRIMESTER">2nd Term</option>
                            <option value="THIRD TRIMESTER">3rd Term</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label><i class="fas fa-search"></i> Search</label>
                        <input type="text" id="filter-search" placeholder="Search courses..." oninput="filterCourses()">
                    </div>
                </div>
                
                <div class="btn-row">
                    <button class="small-btn" onclick="selectAllVisible()"><i class="fas fa-check-double"></i> Select All Visible</button>
                    <button class="small-btn secondary" onclick="deselectAllVisible()"><i class="fas fa-times"></i> Deselect All</button>
                </div>
                
                <div id="checklist" class="checklist">
                    <p style="padding: 20px; text-align: center; color: var(--text-secondary);">Loading courses...</p>
                </div>
                
                <div class="selected-panel">
                    <h4><i class="fas fa-check-circle"></i> Selected Subjects (<span id="selected-count">0</span>) - <span id="selected-units">0</span> units</h4>
                    <div id="selected-tags" class="selected-tags">
                        <span class="empty-msg">No subjects selected yet</span>
                    </div>
                </div>
            </div>
            
            <button class="generate-btn" id="generateBtn" onclick="generatePlan()" disabled>
                <i class="fas fa-magic"></i> Generate Study Plan
            </button>
            
            <button class="generate-btn" onclick="showWhatIfAnalysis()" style="margin-top: 10px; background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                <i class="fas fa-question-circle"></i> What-If Analysis
            </button>
        </div>

        <div class="loading" id="loading">
            <i class="fas fa-spinner"></i>
            <p>Analyzing your curriculum...</p>
        </div>

        <div class="section" id="results">
            <h2><span class="step-num">3</span> Your Study Plan Results</h2>
            
            <div class="charts-grid">
                <div class="chart-box">
                    <h4><i class="fas fa-chart-pie"></i> Curriculum Progress</h4>
                    <canvas id="progressChart"></canvas>
                </div>
                <div class="chart-box">
                    <h4><i class="fas fa-chart-bar"></i> Progress by Year</h4>
                    <canvas id="yearChart"></canvas>
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%;">0%</div>
            </div>

            <div class="stats">
                <div class="stat-card passed">
                    <h3><i class="fas fa-check-circle"></i> Passed</h3>
                    <div class="value" id="passedCount">0</div>
                    <div class="sub-value"><span id="passedUnits">0</span> units</div>
                </div>
                <div class="stat-card available">
                    <h3><i class="fas fa-unlock"></i> Available</h3>
                    <div class="value" id="availableCount">0</div>
                    <div class="sub-value"><span id="availableUnits">0</span> units</div>
                </div>
                <div class="stat-card locked">
                    <h3><i class="fas fa-lock"></i> Locked</h3>
                    <div class="value" id="lockedCount">0</div>
                </div>
                <div class="stat-card">
                    <h3><i class="fas fa-book"></i> Total</h3>
                    <div class="value" id="totalCount">0</div>
                    <div class="sub-value"><span id="totalUnits">0</span> units</div>
                </div>
                <div class="stat-card units">
                    <h3><i class="fas fa-star"></i> Recommended</h3>
                    <div class="value" id="recommendedCountStat">0</div>
                    <div class="sub-value"><span id="recommendedUnitsStat">0</span> units</div>
                </div>
            </div>

            <div class="recommendation-box" id="recommendationBox">
                <div class="recommendation-header">
                    <h3><i class="fas fa-star"></i> Recommended for Next Term</h3>
                    <div class="next-term-badge" id="nextTermBadge">Loading...</div>
                </div>
                <p class="recommendation-subtitle">Based on your passed subjects, you can take these courses next term:</p>
                <div class="recommended-stats">
                    <span><i class="fas fa-book-open"></i> <strong id="recommendedCount">0</strong> subjects</span>
                    <span><i class="fas fa-graduation-cap"></i> <strong id="recommendedUnits">0</strong> units</span>
                </div>
                <table class="recommended-table">
                    <thead>
                        <tr><th>Code</th><th>Subject</th><th>Prerequisite</th><th>Units</th></tr>
                    </thead>
                    <tbody id="recommendedBody"></tbody>
                </table>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('available', this)">
                    <i class="fas fa-unlock"></i> All Available (<span id="availableTab">0</span>)
                </button>
                <button class="tab-btn" onclick="showTab('passed', this)">
                    <i class="fas fa-check"></i> Passed (<span id="passedTab">0</span>)
                </button>
                <button class="tab-btn" onclick="showTab('locked', this)">
                    <i class="fas fa-lock"></i> Locked (<span id="lockedTab">0</span>)
                </button>
            </div>

            <div class="tab-content active" id="availableContent">
                <table>
                    <thead><tr><th>Year</th><th>Term</th><th>Code</th><th>Subject</th><th>Prerequisite</th><th>Units</th></tr></thead>
                    <tbody id="availableBody"></tbody>
                </table>
            </div>

            <div class="tab-content" id="passedContent">
                <table>
                    <thead><tr><th>Year</th><th>Term</th><th>Code</th><th>Subject</th><th>Units</th></tr></thead>
                    <tbody id="passedBody"></tbody>
                </table>
            </div>

            <div class="tab-content" id="lockedContent">
                <table>
                    <thead><tr><th>Year</th><th>Term</th><th>Code</th><th>Subject</th><th>Missing Prerequisites</th><th>Units</th></tr></thead>
                    <tbody id="lockedBody"></tbody>
                </table>
            </div>
            
            <div class="gwa-section" id="gwaSection" style="display: none;">
                <h4><i class="fas fa-calculator"></i> GWA Calculator</h4>
                <div id="gradeInputs"></div>
                <button class="small-btn success" onclick="calculateGWA()" style="margin-top: 15px;">
                    <i class="fas fa-calculator"></i> Calculate GWA
                </button>
                <div class="gwa-result" id="gwaResult" style="display: none;">
                    <div class="gwa-label">Your GWA</div>
                    <div class="gwa-value" id="gwaValue">0.00</div>
                </div>
            </div>
        </div>

        <footer>
            <p>Student Academic Study Planner (SASP) &copy; 2026</p>
            <p style="font-size: 0.8rem; margin-top: 5px;">Save your progress locally and plan your academic journey!</p>
        </footer>
    </div>

    <div class="modal" id="subjectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalSubjectCode">Subject Code</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="detail-row"><span class="detail-label">Subject Name:</span><span class="detail-value" id="modalSubjectName"></span></div>
                <div class="detail-row"><span class="detail-label">Year Level:</span><span class="detail-value" id="modalYearLevel"></span></div>
                <div class="detail-row"><span class="detail-label">Term:</span><span class="detail-value" id="modalTerm"></span></div>
                <div class="detail-row"><span class="detail-label">Units:</span><span class="detail-value" id="modalUnits"></span></div>
                <div class="detail-row"><span class="detail-label">Lecture Hours:</span><span class="detail-value" id="modalLecHours"></span></div>
                <div class="detail-row"><span class="detail-label">Lab Hours:</span><span class="detail-value" id="modalLabHours"></span></div>
                <div class="detail-row"><span class="detail-label">Prerequisites:</span><span class="detail-value" id="modalPrereq"></span></div>
                <div class="detail-row"><span class="detail-label">Corequisites:</span><span class="detail-value" id="modalCoreq"></span></div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="whatifModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                <h3><i class="fas fa-question-circle"></i> What-If Analysis</h3>
                <button class="modal-close" onclick="closeWhatIfModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; color: var(--text-secondary);">Select subjects you plan to pass this term to see what becomes available next:</p>
                <div id="whatifChecklist" class="checklist" style="max-height: 300px;"></div>
                <button class="small-btn success" onclick="runWhatIfAnalysis()" style="margin-top: 15px; width: 100%;">
                    <i class="fas fa-play"></i> Run Analysis
                </button>
                <div id="whatifResults" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <script>
        var currentProgram = 'BSCS';
        var allCourses = [];
        var selectedCourses = {};
        var currentMethod = 'manual';
        var lastResults = null;
        var progressChart = null;
        var yearChart = null;

        function toggleTheme() {
            var body = document.body;
            var icon = document.getElementById('themeIcon');
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                icon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                icon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'dark');
            }
        }

        function loadTheme() {
            var savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                document.getElementById('themeIcon').className = 'fas fa-sun';
            }
        }

        function saveProgress() {
            var data = {
                program: currentProgram,
                passedSubjects: Object.keys(selectedCourses),
                manualInput: document.getElementById('passedInput').value,
                savedAt: new Date().toISOString()
            };
            localStorage.setItem('sasp_progress_' + currentProgram, JSON.stringify(data));
            alert('Progress saved successfully!');
        }

        function loadProgress() {
            var saved = localStorage.getItem('sasp_progress_' + currentProgram);
            if (saved) {
                var data = JSON.parse(saved);
                selectedCourses = {};
                for (var i = 0; i < data.passedSubjects.length; i++) {
                    selectedCourses[data.passedSubjects[i]] = true;
                }
                document.getElementById('passedInput').value = data.manualInput || data.passedSubjects.join('\n');
                updateSelectedTags();
                renderChecklist();
                validateInput();
                alert('Progress loaded! Last saved: ' + new Date(data.savedAt).toLocaleString());
            } else {
                alert('No saved progress found for ' + currentProgram);
            }
        }

        function clearProgress() {
            if (confirm('Are you sure you want to clear all progress?')) {
                localStorage.removeItem('sasp_progress_' + currentProgram);
                selectedCourses = {};
                document.getElementById('passedInput').value = '';
                updateSelectedTags();
                renderChecklist();
                validateInput();
                alert('Progress cleared!');
            }
        }

        function exportProgress() {
            var data = {
                program: currentProgram,
                passedSubjects: Object.keys(selectedCourses),
                manualInput: document.getElementById('passedInput').value,
                exportedAt: new Date().toISOString()
            };
            var blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'SASP_Progress_' + currentProgram + '_' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
        }

        function importProgress(event) {
            var file = event.target.files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        var data = JSON.parse(e.target.result);
                        selectedCourses = {};
                        for (var i = 0; i < data.passedSubjects.length; i++) {
                            selectedCourses[data.passedSubjects[i]] = true;
                        }
                        document.getElementById('passedInput').value = data.manualInput || data.passedSubjects.join('\n');
                        updateSelectedTags();
                        renderChecklist();
                        validateInput();
                        alert('Progress imported successfully!');
                    } catch (err) {
                        alert('Error reading file: ' + err.message);
                    }
                };
                reader.readAsText(file);
            }
            event.target.value = '';
        }

        function exportToPDF() {
            window.print();
        }

        window.onload = function() {
            loadTheme();
            loadCourses();
            validateInput();
            var saved = localStorage.getItem('sasp_progress_' + currentProgram);
            if (saved) {
                var data = JSON.parse(saved);
                selectedCourses = {};
                for (var i = 0; i < data.passedSubjects.length; i++) {
                    selectedCourses[data.passedSubjects[i]] = true;
                }
                document.getElementById('passedInput').value = data.manualInput || data.passedSubjects.join('\n');
                validateInput();
            }
        };

        function validateInput() {
            var btn = document.getElementById('generateBtn');
            var isValid = false;
            if (currentMethod === 'manual') {
                var input = document.getElementById('passedInput').value.trim();
                isValid = input.length > 0;
            } else {
                isValid = Object.keys(selectedCourses).length > 0;
            }
            btn.disabled = !isValid;
        }

        function selectProgram(program, btn) {
            currentProgram = program;
            var btns = document.querySelectorAll('.program-btn');
            for (var i = 0; i < btns.length; i++) btns[i].classList.remove('active');
            btn.classList.add('active');
            document.getElementById('results').style.display = 'none';
            document.getElementById('errorMsg').style.display = 'none';
            selectedCourses = {};
            document.getElementById('passedInput').value = '';
            updateSelectedTags();
            loadCourses();
            validateInput();
            var saved = localStorage.getItem('sasp_progress_' + currentProgram);
            if (saved && confirm('Found saved progress for ' + currentProgram + '. Load it?')) {
                loadProgress();
            }
        }

        function loadCourses() {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/courses/' + currentProgram, true);
            xhr.onload = function() {
                if (xhr.status === 200) {
                    allCourses = JSON.parse(xhr.responseText);
                    renderChecklist();
                }
            };
            xhr.send();
        }

        function renderChecklist() {
            var checklist = document.getElementById('checklist');
            if (!allCourses || allCourses.length === 0) {
                checklist.innerHTML = '<p style="padding: 20px; text-align: center;">No courses found</p>';
                return;
            }
            var grouped = {};
            for (var i = 0; i < allCourses.length; i++) {
                var c = allCourses[i];
                var key = (c.year_level || '?') + ' - ' + (c.term || '?');
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(c);
            }
            var html = '';
            for (var groupKey in grouped) {
                html += '<div class="checklist-header" data-group="' + groupKey + '">' + groupKey + '</div>';
                var courses = grouped[groupKey];
                for (var j = 0; j < courses.length; j++) {
                    var c = courses[j];
                    var checked = selectedCourses[c.code] ? 'checked' : '';
                    var itemClass = selectedCourses[c.code] ? 'checklist-item checked' : 'checklist-item';
                    html += '<div class="' + itemClass + '" data-code="' + c.code + '" data-year="' + (c.year_level || '') + '" data-term="' + (c.term || '') + '" data-name="' + (c.subject_course || '') + '" onclick="showSubjectDetails(\'' + (c.code || '').replace(/'/g, "\\'") + '\')">' +
                        '<input type="checkbox" ' + checked + ' onclick="event.stopPropagation(); toggleCourse(\'' + c.code + '\', this)">' +
                        '<span class="code">' + c.code + '</span>' +
                        '<span class="name">' + (c.subject_course || '') + '</span>' +
                        '<span class="units">' + (c.total_units || 0) + ' units</span></div>';
                }
            }
            checklist.innerHTML = html;
            filterCourses();
            updateSelectedTags();
        }

        function showSubjectDetails(code) {
            var subject = null;
            for (var i = 0; i < allCourses.length; i++) {
                if (allCourses[i].code === code) { subject = allCourses[i]; break; }
            }
            if (!subject) return;
            document.getElementById('modalSubjectCode').textContent = subject.code || '';
            document.getElementById('modalSubjectName').textContent = subject.subject_course || '';
            document.getElementById('modalYearLevel').textContent = subject.year_level || '';
            document.getElementById('modalTerm').textContent = subject.term || '';
            document.getElementById('modalUnits').textContent = subject.total_units || 0;
            document.getElementById('modalLecHours').textContent = subject.lec_hours || 0;
            document.getElementById('modalLabHours').textContent = subject.lab_hours || 0;
            document.getElementById('modalPrereq').textContent = subject.prereq || 'None';
            document.getElementById('modalCoreq').textContent = subject.coreq || 'None';
            document.getElementById('subjectModal').classList.add('active');
        }

        function closeModal() { document.getElementById('subjectModal').classList.remove('active'); }

        function toggleCourse(code, checkbox) {
            if (checkbox.checked) {
                selectedCourses[code] = true;
                checkbox.parentElement.classList.add('checked');
            } else {
                delete selectedCourses[code];
                checkbox.parentElement.classList.remove('checked');
            }
            updateSelectedTags();
            syncToTextarea();
            validateInput();
        }

        function removeCourse(code) {
            delete selectedCourses[code];
            updateSelectedTags();
            syncToTextarea();
            validateInput();
            var items = document.querySelectorAll('.checklist-item[data-code="' + code + '"]');
            for (var i = 0; i < items.length; i++) {
                items[i].classList.remove('checked');
                var cb = items[i].querySelector('input[type="checkbox"]');
                if (cb) cb.checked = false;
            }
        }

        function updateSelectedTags() {
            var tagsContainer = document.getElementById('selected-tags');
            var countEl = document.getElementById('selected-count');
            var codes = Object.keys(selectedCourses);
            countEl.textContent = codes.length;
            var totalUnits = 0;
            for (var i = 0; i < allCourses.length; i++) {
                if (codes.indexOf(allCourses[i].code) >= 0) totalUnits += allCourses[i].total_units || 0;
            }
            document.getElementById('selected-units').textContent = totalUnits;
            if (codes.length === 0) {
                tagsContainer.innerHTML = '<span class="empty-msg">No subjects selected yet</span>';
            } else {
                var html = '';
                for (var i = 0; i < codes.length; i++) {
                    html += '<span class="tag">' + codes[i] + '<button onclick="event.stopPropagation(); removeCourse(\'' + codes[i] + '\')">&times;</button></span>';
                }
                tagsContainer.innerHTML = html;
            }
        }

        function syncToTextarea() {
            document.getElementById('passedInput').value = Object.keys(selectedCourses).join('\n');
        }

        function switchMethod(method) {
            currentMethod = method;
            var tabs = document.querySelectorAll('.method-tab');
            var contents = document.querySelectorAll('.method-content');
            for (var i = 0; i < tabs.length; i++) tabs[i].classList.remove('active');
            for (var i = 0; i < contents.length; i++) contents[i].classList.remove('active');
            if (method === 'manual') {
                tabs[0].classList.add('active');
                document.getElementById('method-manual').classList.add('active');
                syncToTextarea();
            } else {
                tabs[1].classList.add('active');
                document.getElementById('method-select').classList.add('active');
                syncFromTextarea();
            }
            validateInput();
        }

        function syncFromTextarea() {
            var input = document.getElementById('passedInput').value;
            var lines = input.split(/[,\n]/);
            selectedCourses = {};
            for (var i = 0; i < lines.length; i++) {
                var code = lines[i].trim().toUpperCase();
                if (code) selectedCourses[code] = true;
            }
            updateSelectedTags();
            var items = document.querySelectorAll('.checklist-item');
            for (var i = 0; i < items.length; i++) {
                var itemCode = items[i].getAttribute('data-code');
                var cb = items[i].querySelector('input[type="checkbox"]');
                if (selectedCourses[itemCode]) {
                    items[i].classList.add('checked');
                    if (cb) cb.checked = true;
                } else {
                    items[i].classList.remove('checked');
                    if (cb) cb.checked = false;
                }
            }
        }

        function filterCourses() {
            var yearFilter = document.getElementById('filter-year').value;
            var termFilter = document.getElementById('filter-term').value;
            var searchFilter = document.getElementById('filter-search').value.toLowerCase();
            var items = document.querySelectorAll('.checklist-item');
            var headers = document.querySelectorAll('.checklist-header');
            var visibleGroups = {};
            for (var i = 0; i < items.length; i++) {
                var item = items[i];
                var year = item.getAttribute('data-year');
                var term = item.getAttribute('data-term');
                var code = item.getAttribute('data-code').toLowerCase();
                var name = item.getAttribute('data-name').toLowerCase();
                var yearMatch = !yearFilter || year === yearFilter;
                var termMatch = !termFilter || term === termFilter;
                var searchMatch = !searchFilter || code.indexOf(searchFilter) >= 0 || name.indexOf(searchFilter) >= 0;
                if (yearMatch && termMatch && searchMatch) {
                    item.style.display = 'flex';
                    visibleGroups[year + ' - ' + term] = true;
                } else {
                    item.style.display = 'none';
                }
            }
            for (var i = 0; i < headers.length; i++) {
                var groupName = headers[i].getAttribute('data-group');
                headers[i].style.display = visibleGroups[groupName] ? 'block' : 'none';
            }
        }

        function selectAllVisible() {
            var items = document.querySelectorAll('.checklist-item');
            for (var i = 0; i < items.length; i++) {
                if (items[i].style.display !== 'none') {
                    var code = items[i].getAttribute('data-code');
                    selectedCourses[code] = true;
                    items[i].classList.add('checked');
                    var cb = items[i].querySelector('input[type="checkbox"]');
                    if (cb) cb.checked = true;
                }
            }
            updateSelectedTags();
            syncToTextarea();
            validateInput();
        }

        function deselectAllVisible() {
            var items = document.querySelectorAll('.checklist-item');
            for (var i = 0; i < items.length; i++) {
                if (items[i].style.display !== 'none') {
                    var code = items[i].getAttribute('data-code');
                    delete selectedCourses[code];
                    items[i].classList.remove('checked');
                    var cb = items[i].querySelector('input[type="checkbox"]');
                    if (cb) cb.checked = false;
                }
            }
            updateSelectedTags();
            syncToTextarea();
            validateInput();
        }

        function showTab(tabName, btn) {
            var tabBtns = document.querySelectorAll('.tab-btn');
            var tabContents = document.querySelectorAll('.tab-content');
            for (var i = 0; i < tabBtns.length; i++) tabBtns[i].classList.remove('active');
            for (var i = 0; i < tabContents.length; i++) tabContents[i].classList.remove('active');
            btn.classList.add('active');
            document.getElementById(tabName + 'Content').classList.add('active');
        }

        function showError(msg) {
            var errorEl = document.getElementById('errorMsg');
            errorEl.textContent = msg;
            errorEl.style.display = 'block';
        }

        function generatePlan() {
            var input = document.getElementById('passedInput').value;
            var lines = input.split(/[,\n]/);
            var passedSubjects = [];
            for (var i = 0; i < lines.length; i++) {
                var s = lines[i].trim().toUpperCase();
                if (s) passedSubjects.push(s);
            }
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('generateBtn').disabled = true;
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/available-subjects/' + currentProgram, true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onload = function() {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('generateBtn').disabled = false;
                if (xhr.status === 200) {
                    var data = JSON.parse(xhr.responseText);
                    if (data.error) showError('Error: ' + data.error);
                    else { lastResults = data; displayResults(data); }
                } else showError('Server error: ' + xhr.status);
            };
            xhr.onerror = function() {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('generateBtn').disabled = false;
                showError('Network error');
            };
            xhr.send(JSON.stringify({ passed_subjects: passedSubjects }));
        }

        function displayResults(data) {
            var stats = data.stats;
            document.getElementById('passedCount').textContent = stats.passed_count;
            document.getElementById('availableCount').textContent = stats.available_count;
            document.getElementById('lockedCount').textContent = stats.locked_count;
            document.getElementById('totalCount').textContent = stats.total_courses;
            document.getElementById('passedUnits').textContent = stats.total_passed_units || 0;
            document.getElementById('availableUnits').textContent = stats.total_available_units || 0;
            document.getElementById('totalUnits').textContent = stats.total_curriculum_units || 0;
            document.getElementById('availableTab').textContent = stats.available_count;
            document.getElementById('passedTab').textContent = stats.passed_count;
            document.getElementById('lockedTab').textContent = stats.locked_count;
            document.getElementById('recommendedCountStat').textContent = stats.recommended_count || 0;
            document.getElementById('recommendedUnitsStat').textContent = stats.recommended_units || 0;
            var progressBar = document.getElementById('progressBar');
            progressBar.style.width = stats.progress_percentage + '%';
            progressBar.textContent = stats.progress_percentage + '% Complete';
            document.getElementById('nextTermBadge').textContent = data.next_term ? data.next_term.display : 'Next Term';
            document.getElementById('recommendedCount').textContent = stats.recommended_count || 0;
            document.getElementById('recommendedUnits').textContent = stats.recommended_units || 0;
            var recommendedHtml = '';
            if (data.recommended && data.recommended.length > 0) {
                for (var i = 0; i < data.recommended.length; i++) {
                    var c = data.recommended[i];
                    recommendedHtml += '<tr onclick="showSubjectDetails(\'' + (c.code || '').replace(/'/g, "\\'") + '\')" style="cursor:pointer;"><td class="code-cell">' + (c.code || '') + '</td><td>' + (c.subject_course || '') + '</td><td>' + (c.prereq || 'NONE') + '</td><td>' + (c.total_units || 0) + '</td></tr>';
                }
            } else {
                recommendedHtml = '<tr><td colspan="4" style="text-align:center;padding:20px;">No recommended subjects</td></tr>';
            }
            document.getElementById('recommendedBody').innerHTML = recommendedHtml;
            var availableHtml = '';
            for (var i = 0; i < data.available.length; i++) {
                var c = data.available[i];
                availableHtml += '<tr class="available-row" onclick="showSubjectDetails(\'' + (c.code || '').replace(/'/g, "\\'") + '\')"><td>' + (c.year_level || '') + '</td><td>' + (c.term || '') + '</td><td><strong>' + (c.code || '') + '</strong></td><td>' + (c.subject_course || '') + '</td><td>' + (c.prereq || 'NONE') + '</td><td>' + (c.total_units || 0) + '</td></tr>';
            }
            if (!availableHtml) availableHtml = '<tr><td colspan="6" style="text-align:center;">No available subjects</td></tr>';
            document.getElementById('availableBody').innerHTML = availableHtml;
            var passedHtml = '';
            for (var i = 0; i < data.passed.length; i++) {
                var c = data.passed[i];
                passedHtml += '<tr class="passed-row" onclick="showSubjectDetails(\'' + (c.code || '').replace(/'/g, "\\'") + '\')"><td>' + (c.year_level || '') + '</td><td>' + (c.term || '') + '</td><td><strong>' + (c.code || '') + '</strong></td><td>' + (c.subject_course || '') + '</td><td>' + (c.total_units || 0) + '</td></tr>';
            }
            if (!passedHtml) passedHtml = '<tr><td colspan="5" style="text-align:center;">No passed subjects</td></tr>';
            document.getElementById('passedBody').innerHTML = passedHtml;
            var lockedHtml = '';
            for (var i = 0; i < data.unavailable.length; i++) {
                var c = data.unavailable[i];
                var missing = c.missing_prereqs ? c.missing_prereqs.join(', ') : c.prereq;
                lockedHtml += '<tr class="locked-row" onclick="showSubjectDetails(\'' + (c.code || '').replace(/'/g, "\\'") + '\')"><td>' + (c.year_level || '') + '</td><td>' + (c.term || '') + '</td><td><strong>' + (c.code || '') + '</strong></td><td>' + (c.subject_course || '') + '</td><td class="missing">' + missing + '</td><td>' + (c.total_units || 0) + '</td></tr>';
            }
            if (!lockedHtml) lockedHtml = '<tr><td colspan="6" style="text-align:center;">All subjects available!</td></tr>';
            document.getElementById('lockedBody').innerHTML = lockedHtml;
            renderCharts(data);
            renderGWAInputs(data.passed);
            document.getElementById('results').style.display = 'block';
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function renderCharts(data) {
            var stats = data.stats;
            if (progressChart) progressChart.destroy();
            if (yearChart) yearChart.destroy();
            var ctx1 = document.getElementById('progressChart').getContext('2d');
            progressChart = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Passed', 'Available', 'Locked'],
                    datasets: [{ data: [stats.passed_count, stats.available_count, stats.locked_count], backgroundColor: ['#27ae60', '#3498db', '#e74c3c'], borderWidth: 0 }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
            var yearData = { 'First Year': { passed: 0, total: 0 }, 'Second Year': { passed: 0, total: 0 }, 'Third Year': { passed: 0, total: 0 }, 'Fourth Year': { passed: 0, total: 0 } };
            for (var i = 0; i < allCourses.length; i++) {
                if (yearData[allCourses[i].year_level]) yearData[allCourses[i].year_level].total++;
            }
            for (var i = 0; i < data.passed.length; i++) {
                if (yearData[data.passed[i].year_level]) yearData[data.passed[i].year_level].passed++;
            }
            var ctx2 = document.getElementById('yearChart').getContext('2d');
            yearChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['1st Year', '2nd Year', '3rd Year', '4th Year'],
                    datasets: [
                        { label: 'Passed', data: [yearData['First Year'].passed, yearData['Second Year'].passed, yearData['Third Year'].passed, yearData['Fourth Year'].passed], backgroundColor: '#27ae60' },
                        { label: 'Remaining', data: [yearData['First Year'].total - yearData['First Year'].passed, yearData['Second Year'].total - yearData['Second Year'].passed, yearData['Third Year'].total - yearData['Third Year'].passed, yearData['Fourth Year'].total - yearData['Fourth Year'].passed], backgroundColor: '#bdc3c7' }
                    ]
                },
                options: { responsive: true, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function showGWACalculator() {
            var gwaSection = document.getElementById('gwaSection');
            gwaSection.style.display = gwaSection.style.display === 'none' ? 'block' : 'none';
            if (gwaSection.style.display === 'block') gwaSection.scrollIntoView({ behavior: 'smooth' });
        }

        function renderGWAInputs(passedSubjects) {
            var container = document.getElementById('gradeInputs');
            if (!passedSubjects || passedSubjects.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">Generate a study plan first.</p>';
                return;
            }
            var grades = ['1.00', '1.25', '1.50', '1.75', '2.00', '2.25', '2.50', '2.75', '3.00', '5.00'];
            var html = '';
            for (var i = 0; i < passedSubjects.length; i++) {
                var s = passedSubjects[i];
                html += '<div class="grade-input-row"><span class="subject-name">' + (s.code || '') + ' - ' + (s.subject_course || '').substring(0, 30) + '</span><span class="units-display">' + (s.total_units || 0) + ' units</span><select data-units="' + (s.total_units || 0) + '" class="grade-select"><option value="">Grade</option>';
                for (var j = 0; j < grades.length; j++) html += '<option value="' + grades[j] + '">' + grades[j] + '</option>';
                html += '</select></div>';
            }
            container.innerHTML = html;
            document.getElementById('gwaSection').style.display = 'block';
        }

        function calculateGWA() {
            var selects = document.querySelectorAll('.grade-select');
            var totalPoints = 0, totalUnits = 0;
            for (var i = 0; i < selects.length; i++) {
                var grade = parseFloat(selects[i].value);
                var units = parseFloat(selects[i].getAttribute('data-units')) || 0;
                if (!isNaN(grade) && units > 0) { totalPoints += grade * units; totalUnits += units; }
            }
            if (totalUnits > 0) {
                document.getElementById('gwaValue').textContent = (totalPoints / totalUnits).toFixed(2);
                document.getElementById('gwaResult').style.display = 'block';
            } else alert('Please select grades for at least one subject.');
        }

        function showWhatIfAnalysis() {
            if (!lastResults || !lastResults.available || lastResults.available.length === 0) {
                alert('Please generate a study plan first.');
                return;
            }
            var container = document.getElementById('whatifChecklist');
            var html = '';
            for (var i = 0; i < lastResults.available.length; i++) {
                var c = lastResults.available[i];
                html += '<div class="checklist-item"><input type="checkbox" class="whatif-check" data-code="' + c.code + '"><span class="code">' + c.code + '</span><span class="name">' + (c.subject_course || '').substring(0, 40) + '</span><span class="units">' + (c.total_units || 0) + ' units</span></div>';
            }
            container.innerHTML = html;
            document.getElementById('whatifResults').innerHTML = '';
            document.getElementById('whatifModal').classList.add('active');
        }

        function closeWhatIfModal() { document.getElementById('whatifModal').classList.remove('active'); }

        function runWhatIfAnalysis() {
            var checks = document.querySelectorAll('.whatif-check:checked');
            var additionalPassed = [];
            for (var i = 0; i < checks.length; i++) additionalPassed.push(checks[i].getAttribute('data-code'));
            if (additionalPassed.length === 0) { alert('Please select at least one subject.'); return; }
            var allPassed = Object.keys(selectedCourses).concat(additionalPassed);
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/available-subjects/' + currentProgram, true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onload = function() {
                if (xhr.status === 200) {
                    var data = JSON.parse(xhr.responseText);
                    var newAvailable = [];
                    for (var i = 0; i < data.available.length; i++) {
                        var c = data.available[i];
                        var wasAvailable = false;
                        for (var j = 0; j < lastResults.available.length; j++) {
                            if (lastResults.available[j].code === c.code) { wasAvailable = true; break; }
                        }
                        if (!wasAvailable && additionalPassed.indexOf(c.code) < 0) newAvailable.push(c);
                    }
                    var resultsHtml = '<h4 style="color: var(--accent-green); margin-bottom: 15px;"><i class="fas fa-unlock"></i> New Subjects That Would Become Available:</h4>';
                    if (newAvailable.length > 0) {
                        resultsHtml += '<table style="width:100%;"><thead><tr><th>Code</th><th>Subject</th><th>Units</th></tr></thead><tbody>';
                        for (var i = 0; i < newAvailable.length; i++) resultsHtml += '<tr><td>' + newAvailable[i].code + '</td><td>' + newAvailable[i].subject_course + '</td><td>' + newAvailable[i].total_units + '</td></tr>';
                        resultsHtml += '</tbody></table>';
                    } else resultsHtml += '<p style="color: var(--text-secondary);">No additional subjects would become available.</p>';
                    resultsHtml += '<p style="margin-top: 15px;"><strong>Summary:</strong> If you pass ' + additionalPassed.length + ' subject(s), ' + newAvailable.length + ' new subject(s) would unlock.</p>';
                    document.getElementById('whatifResults').innerHTML = resultsHtml;
                }
            };
            xhr.send(JSON.stringify({ passed_subjects: allPassed }));
        }

        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) e.target.classList.remove('active');
        });
    </script>
</body>
</html>
